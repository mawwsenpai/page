<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Profil Baru</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="../css/root.css">

    <style>

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            /* overflow: hidden; dijaga dari kode asli Anda */
            overflow: hidden;
        }

        /* ==============================================
           2. ANIMASI LATAR BELAKANG (TIDAK DIUBAH)
           ============================================== */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,dark,tech');
            background-size: cover;
            background-position: center;
        }

        .image-flow-container {
            display: flex;
            width: fit-content;
            height: 100%;
            animation: slideBackground 150s linear infinite;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .image-flow-container.loaded {
            opacity: 1;
        }

        .content-wrapper {
            display: flex;
            align-items: flex-start;
            height: 100%;
        }

        .masonry-column {
            display: flex;
            flex-direction: column;
            width: 160px;
            margin: 0 2px;
        }

        .grid-item {
            position: relative;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            filter: grayscale(70%) brightness(50%);
            transition: all 0.3s ease;
            cursor: default;
            margin-bottom: 4px;
        }

        .grid-item.placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(var(--accent-color-rgb), 0.5), transparent);
            transform: translateX(-100%);
            animation: glowLine 5s infinite linear;
            animation-delay: calc(Math.random() * 5s);
        }

        @keyframes glowLine {
            0% { transform: translateX(-150%); }
            100% { transform: translateX(150%); }
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .grid-item.loaded img {
            opacity: 1;
        }

        .grid-item:hover {
            filter: grayscale(0%) brightness(100%);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.6);
            border-color: var(--accent-color);
        }

        @keyframes slideBackground {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* ==============================================
           3. GAYA POPUP NOTIFIKASI (REFERENSI)
           ============================================== */
        .notification-popup {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            padding: 2.5rem 3.5rem;
            border-radius: 20px;
            border: 2px solid rgba(var(--border-color), .5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
            z-index: 10;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            max-width: 90%;
            transition: transform .4s ease-out, opacity .4s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }

        .notification-popup.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* ... gaya notifikasi lainnya ... */
        .notification-popup .title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 2px 5px rgba(0,0,0,.5);
            margin: 0;
        }
        .notification-popup p {
            font-size: 1.1rem;
            margin: 0;
            color: var(--text-primary);
        }
        .notification-popup a {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--accent-text);
            padding: .75rem 2.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all .2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,.3);
        }
        .notification-popup a:hover {
            background-color: #f7e0a8;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,.4);
        }


        /* ==============================================
           4. KONTEN UTAMA (SETUP FORM) - DIROMBAK
           ============================================== */
        .setup-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--padding-md);
            position: relative;
            z-index: 2; /* Pastikan di atas animasi bg */
        }

        /* GAYA BARU: Meniru .notification-popup */
        .setup-card {
            /* Terapkan Glassmorphism */
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            
            /* Terapkan Border & Radius */
            border-radius: 20px; /* Sesuai notifikasi */
            border: 2px solid rgba(var(--border-color), .5); /* Sesuai notifikasi */
            
            /* Terapkan Shadow */
            box-shadow: 0 10px 30px rgba(0, 0, 0, .6); /* Sesuai notifikasi */
            
            /* Layout & Ukuran */
            padding: var(--padding-lg);
            max-width: 400px;
            width: 100%;

            /* Animasi fade-in sederhana */
            opacity: 0;
            transform: scale(0.98);
            animation: fadeInCard 0.5s ease-out 0.2s forwards;
        }

        @keyframes fadeInCard {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .step-panel {
            min-height: 250px;
            transition: opacity 0.3s ease;
        }

        .step-panel.active {
            display: block;
        }

        .step-panel:not(.active) {
            display: none;
            opacity: 0;
        }

        .setup-header {
            text-align: center;
            margin-bottom: var(--padding-md);
        }

        .step-indicator {
            font-size: 0.9em;
            color: var(--accent-color);
            font-weight: 600;
            margin: 0;
        }

        .step-title {
            font-size: 1.5rem;
            margin-top: 5px;
            color: var(--text-primary);
        }

        /* ==============================================
           5. ELEMEN FORM & TOMBOL
           ============================================== */
        
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: var(--padding-sm);
        }

        .form-group label {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        /* Input dibuat sedikit transparan agar cocok dengan tema glass */
        .text-input {
            font-family: var(--font-ui);
            background-color: rgba(var(--bg-primary-rgb), 0.7); /* Transparan */
            border: var(--border-style);
            border-radius: var(--border-radius-sm);
            padding: 12px 15px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition-fast);
            width: 100%;
        }
        
        .text-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .text-input:focus,
        .text-input:focus-visible {
            outline: none;
            border-color: var(--accent-color);
            background-color: rgba(var(--bg-primary-rgb), 0.9); /* Lebih solid saat fokus */
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.25);
        }

        textarea.text-input {
            resize: vertical;
            min-height: 100px;
        }


        .input-group-centered {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: var(--padding-md);
        }

        .profile-photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-color);
            box-shadow: var(--shadow-md);
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: var(--padding-lg);
            gap: var(--padding-sm);
        }
        
        /* Gaya Tombol (diasumsikan ada di root.css, tapi ditambahkan di sini untuk kelengkapan) */
        .app-button {
            font-family: var(--font-ui);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 12px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .app-button.primary {
            background-color: var(--accent-color);
            color: var(--accent-text);
            box-shadow: var(--shadow-sm);
        }
        .app-button.primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .app-button.outline {
            background-color: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }
        .app-button.outline:hover {
            background-color: var(--interactive-active-bg);
        }

        /* ==============================================
           6. LOADING OVERLAY
           ============================================== */
        /* Diasumsikan ada di root.css, tapi ditambahkan di sini untuk kelengkapan */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-loading, 9999);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            opacity: 0;
            visibility: hidden;
            transition: opacity .2s ease, visibility .2s ease;
        }

        .loading-overlay.is-open {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: var(--text-primary);
            margin-top: var(--padding-sm);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="animated-background">
        <div class="image-flow-container" id="imageFlowContainer"></div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loading-text"></p>
    </div>

    <div class="setup-container">
        <div class="setup-card">
            <div class="setup-header">
                <p class="step-indicator" id="step-indicator">Langkah 1 dari 3</p>
                <h2 class="step-title" id="step-title">Pengaturan Profil</h2>
            </div>

            <div class="step-panel active" data-step="1">
                <div class="form-group">
                    <label for="input-name">Nama Pengguna (Display Name)</label>
                    <input type="text" id="input-name" class="text-input" placeholder="Misalnya: Jagoan Koding" />
                </div>
            </div>

            <div class="step-panel" data-step="2">
                <div class="form-group">
                    <label for="input-desc">Deskripsi Singkat (Bio)</label>
                    <textarea id="input-desc" class="text-input" placeholder="Ceritakan sedikit tentang diri Anda..."></textarea>
                </div>
            </div>

            <div class="step-panel" data-step="3">
                <div class="input-group-centered">
                    <img id="photo-preview" class="profile-photo-preview" src="https://ui-avatars.com/api/?name=U&amp;background=random" />
                    <input type="file" id="input-photo" accept="image/*" style="display: none;" />
                    <button class="app-button outline" onclick="document.getElementById('input-photo').click()">
                        <i class="fas fa-upload"></i> Pilih Foto
                    </button>
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin: 0;">Foto Anda akan dioptimalkan.</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="app-button outline" id="prev-btn" style="visibility: hidden;">&larr; Kembali</button>
                <button class="app-button primary" id="next-btn">Lanjut &rarr;</button>
                <button class="app-button primary" id="save-btn" style="display: none;">Simpan Profil</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script src="js/config.js"></script>
    <script>
        // --- Konstanta & Utilitas ---
        const DEFAULT_PHOTO = "https://ui-avatars.com/api/?name=U&background=random";

        const showLoading = (text = "Memuat...") => {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.add('is-open');
        };
        const hideLoading = () => document.getElementById('loading-overlay').classList.remove('is-open');

        const showNotification = (msg, isError = false) => {
            console.log(`Notifikasi (${isError ? 'Error' : 'Info'}):`, msg);
            alert(msg); // Placeholder notifikasi
        };

        // --- Variabel Global ---
        let currentStep = 1;
        let currentUser = null;
        let auth, database, gapiTokenClient;
        let profileData = {
            name: '',
            desc: '',
            photo: DEFAULT_PHOTO,
            socials: {}
        };

        // --- Elemen DOM ---
        const el = {
            stepPanels: document.querySelectorAll('.step-panel'),
            stepIndicator: document.getElementById('step-indicator'),
            stepTitle: document.getElementById('step-title'),
            nextBtn: document.getElementById('next-btn'),
            prevBtn: document.getElementById('prev-btn'),
            saveBtn: document.getElementById('save-btn'),
            inputName: document.getElementById('input-name'),
            inputDesc: document.getElementById('input-desc'),
            inputPhoto: document.getElementById('input-photo'),
            photoPreview: document.getElementById('photo-preview')
        };


        // --- Fungsi Utama UI & Gambar ---

        function updateStepUI() {
            el.stepPanels.forEach(panel => panel.classList.remove('active'));
            const activePanel = document.querySelector(`[data-step="${currentStep}"]`);
            if (activePanel) {
                activePanel.classList.add('active');
            }

            el.stepIndicator.textContent = `Langkah ${currentStep} dari 3`;
            el.prevBtn.style.visibility = (currentStep > 1) ? 'visible' : 'hidden';

            if (currentStep < 3) {
                el.nextBtn.style.display = 'block';
                el.saveBtn.style.display = 'none';
                el.stepTitle.textContent = currentStep === 1 ? 'Siapa Nama Anda?' : 'Deskripsikan Diri Anda';
            } else if (currentStep === 3) {
                el.nextBtn.style.display = 'none';
                el.saveBtn.style.display = 'block';
                el.stepTitle.textContent = 'Upload Foto Profil';
            }
        }

        // Fungsi untuk mengubah ukuran gambar
        function resizeAndEncodeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > height) {
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        } else {
                            if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Fungsi untuk meminta token GAPI
        function requestGapiToken() {
            return new Promise((resolve, reject) => {
                const token = gapi.client.getToken();
                if (token && token.access_token && (!token.expires_at || (token.expires_at > Date.now() + 60000))) {
                    resolve();
                    return;
                }
                
                gapiTokenClient.callback = (tokenResponse) => {
                    if (tokenResponse.error) {
                        reject(new Error("Otorisasi Google Blogger gagal. Mohon izinkan akses."));
                    } else {
                        resolve();
                    }
                };
                gapiTokenClient.requestAccessToken({ prompt: 'consent' });
            });
        }


        // --- Logika Navigasi & Simpan ---

        function handleNavigation(direction) {
            if (direction === 'next') {
                // Validasi data per langkah
                if (currentStep === 1) {
                    profileData.name = el.inputName.value.trim();
                    if (!profileData.name) {
                        showNotification("Nama tidak boleh kosong!", true);
                        return;
                    }
                } else if (currentStep === 2) {
                    profileData.desc = el.inputDesc.value.trim();
                }
                currentStep = Math.min(3, currentStep + 1);
            } else if (direction === 'prev') {
                currentStep = Math.max(1, currentStep - 1);
            }
            updateStepUI();
        }

        async function saveProfile() {
            showLoading("Meminta Otorisasi Blogger...");
            if (!currentUser) {
                showNotification("Pengguna belum terotentikasi. Silakan refresh.", true);
                hideLoading();
                return;
            }

            try {
                // 1. Otorisasi GAPI
                await requestGapiToken();

                // 2. Proses Foto
                showLoading("Memproses Foto dan Data...");
                const photoFile = el.inputPhoto.files[0];
                let photoUrl = currentUser.photoURL || DEFAULT_PHOTO;

                if (photoFile) {
                    photoUrl = await resizeAndEncodeImage(photoFile);
                }
                profileData.photo = photoUrl;

                // 3. Cari Blog Pengguna
                showLoading("Mencari blog Anda...");
                const blogsResponse = await gapi.client.blogger.blogs.listByUser({ userId: 'self' });
                if (!blogsResponse.result.items || blogsResponse.result.items.length === 0) {
                    throw new Error("Anda tidak punya blog. Buat blog di Blogger.com dulu.");
                }
                const blogId = blogsResponse.result.items[0].id;

                // 4. Buat Postingan Profil Baru
                showLoading("Membuat postingan profil...");
                const finalProfileData = {
                    ...profileData,
                    firebaseUid: currentUser.uid,
                    email: currentUser.email,
                    socials: { tiktok: '', instagram: '', youtube: '', facebook: '' } // Data sosial diisi nanti
                };
                
                const newPostResource = {
                    title: currentUser.uid, // Judul post adalah UID
                    content: JSON.stringify(finalProfileData),
                    labels: ["RevisiPro-Profile"],
                    isDraft: false
                };
                
                const createResponse = await gapi.client.blogger.posts.insert({
                    blogId: blogId,
                    resource: newPostResource
                });
                
                const { id: postId, url: postUrl } = createResponse.result;

                // 5. Simpan Referensi ke Firebase RTDB
                showLoading("Menyimpan referensi ke Firebase...");
                const userProfileRef = database.ref(`profiles/${currentUser.uid}`);
                await userProfileRef.set({ blogId, postId, postUrl });

                showNotification("Profil berhasil dibuat! Anda diarahkan ke halaman utama.", false);
                
                // 6. Redirect
                window.location.href = "profile.html";

            } catch (error) {
                console.error("Gagal Menyimpan Profil:", error);
                showNotification(`Gagal: ${error.message}`, true);
            } finally {
                hideLoading();
            }
        }


        // --- Inisialisasi Utama (Window Load) ---

        window.onload = () => {
            showLoading("Memuat sesi pengguna...");

            // Inisialisasi Firebase
            try {
                firebase.initializeApp(config.firebase);
                auth = firebase.auth();
                database = firebase.database();
            } catch (e) {
                showNotification("Gagal inisialisasi Firebase.", true);
                hideLoading();
                return;
            }

            // Inisialisasi GAPI Client
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: config.gapi.apiKey,
                        discoveryDocs: config.gapi.discoveryDocs
                    });
                    
                    gapiTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: config.gapi.clientId,
                        scope: config.gapi.scope,
                        callback: () => {},
                    });

                    // Cek status autentikasi Firebase
                    auth.onAuthStateChanged((user) => {
                        if (!user) {
                            window.location.href = "main.html"; // Wajib login
                            return;
                        }
                        
                        currentUser = user;
                        el.inputName.value = user.displayName || user.email.split('@')[0];
                        el.photoPreview.src = user.photoURL || DEFAULT_PHOTO;

                        // Cek apakah profil sudah ada di database
                        database.ref(`profiles/${user.uid}`).once('value', (snapshot) => {
                            if (snapshot.exists()) {
                                // Jika sudah ada, lempar ke halaman profil
                                window.location.href = "profile.html";
                            } else {
                                // Jika belum ada, tampilkan form setup
                                hideLoading();
                                updateStepUI();
                            }
                        });
                    });

                } catch (error) {
                    showNotification("Gagal inisialisasi Google API Client.", true);
                    hideLoading();
                }
            });

            // Event Listeners Tombol
            el.nextBtn.addEventListener('click', () => handleNavigation('next'));
            el.prevBtn.addEventListener('click', () => handleNavigation('prev'));
            el.saveBtn.addEventListener('click', saveProfile);

            // Event Listener Upload Foto
            el.inputPhoto.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { el.photoPreview.src = event.target.result; };
                    reader.readAsDataURL(file);
                }
            });
        };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tampilkan popup jika ada
            const popup = document.getElementById('notificationPopup');
            if (popup) {
                setTimeout(() => popup.classList.add('show'), 500);
            }
            // Muat gambar fallback dulu
            populateImageFlow(getFallbackImages(), false);
            // Ambil gambar asli dari blog
            fetchBlogImages();
        });

        async function fetchBlogImages() {
            const imageFlowContainer = document.getElementById('imageFlowContainer');
            if (!imageFlowContainer) return;

            // Cek konfigurasi
            if (typeof config === 'undefined' || !Array.isArray(config.blogIds) || config.blogIds.length === 0 || !config.apiKey) {
                console.error("Konfigurasi Belum Valid! Harap isi blogIds (array) dan apiKey.");
                return;
            }

            // 1. Buat array promise untuk fetch semua blogId
            const fetchPromises = config.blogIds.map(blogId => {
                const url = `https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts?key=${config.apiKey}&maxResults=150&fields=items(content)`;
                return fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            console.warn(`Gagal fetch Blog ID ${blogId}. Status: ${response.status}`);
                            return null; // Kembalikan null agar Promise.all tidak gagal
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error(`Error jaringan Blog ID ${blogId}:`, error);
                        return null;
                    });
            });

            let imageUrls = [];

            try {
                // 2. Tunggu semua fetch selesai
                const results = await Promise.all(fetchPromises);

                // 3. Iterasi hasil dari semua blog
                results.forEach(data => {
                    if (data && data.items) {
                        data.items.forEach(post => {
                            if (!post.content) return;
                            
                            // Ekstrak tag <img>
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = post.content;
                            const imgTags = tempDiv.querySelectorAll('img');
                            
                            imgTags.forEach(imgTag => {
                                if (imgTag && imgTag.src) {
                                    imageUrls.push(imgTag.src);
                                }
                            });
                        });
                    }
                });

                // 4. Tampilkan gambar jika ada
                if (imageUrls.length > 0) {
                    console.log(`Berhasil menemukan ${imageUrls.length} gambar.`);
                    let finalImageSet = [...imageUrls];
                    
                    // Gandakan gambar jika terlalu sedikit
                    if (finalImageSet.length < 30) {
                        while (finalImageSet.length < 80) {
                            finalImageSet.push(...imageUrls);
                        }
                    }
                    
                    populateImageFlow(finalImageSet);
                } else {
                    console.warn("Tidak ada gambar ditemukan, menggunakan gambar fallback.");
                }
            } catch (error) {
                console.error('Gagal memproses data dari Blogger API.', error);
            }
        }

        function getFallbackImages() {
            const fallbackUrls = [
                'https://source.unsplash.com/random/400x600?game,art', 
                'https://source.unsplash.com/random/400x500?tech,abstract', 
                'https://source.unsplash.com/random/400x400?minimal,design', 
                'https://source.unsplash.com/random/400x700?cyber,puzzle',
                'https://source.unsplash.com/random/400x300?creative,geometric'
            ];
            let fullFallback = [];
            for (let i = 0; i < 20; i++) {
                fullFallback.push(...fallbackUrls);
            }
            return fullFallback;
        }

        function populateImageFlow(urls, isActualImages = true) {
            const imageFlowContainer = document.getElementById('imageFlowContainer');
            urls.sort(() => 0.5 - Math.random()); // Acak gambar
            
            const wrapper1 = createContentWrapper(urls, isActualImages);
            const wrapper2 = wrapper1.cloneNode(true); // Duplikat untuk animasi loop
            
            imageFlowContainer.innerHTML = '';
            imageFlowContainer.appendChild(wrapper1);
            imageFlowContainer.appendChild(wrapper2);
            
            setTimeout(() => {
                imageFlowContainer.classList.add('loaded');
            }, 20);
        }

        function createContentWrapper(urls, isActualImages) {
            const wrapper = document.createElement('div');
            wrapper.className = 'content-wrapper';
            const panelHeights = [100, 120, 140, 160, 180, 200, 220, 240, 260];
            const columnWidth = 160 + 4; // 160px width + 4px margin
            const viewHeight = window.innerHeight;
            const numColumns = Math.ceil(window.innerWidth / columnWidth) + 2; // +2 buffer
            const columns = [];
            const columnHeights = new Array(numColumns).fill(0);

            for (let i = 0; i < numColumns; i++) {
                const column = document.createElement('div');
                column.className = 'masonry-column';
                wrapper.appendChild(column);
                columns.push(column);
            }

            let imageIndex = 0;
            for (let i = 0; i < numColumns; i++) {
                while (columnHeights[i] < viewHeight) {
                    if (urls.length === 0) break;
                    const imageUrl = urls[imageIndex % urls.length];
                    const randomHeight = panelHeights[Math.floor(Math.random() * panelHeights.length)];

                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    item.style.height = `${randomHeight}px`;

                    if (isActualImages) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.loading = 'lazy';
                        img.onload = () => item.classList.add('loaded');
                        img.onerror = () => item.classList.remove('loaded');
                        item.appendChild(img);
                    } else {
                        item.classList.add('placeholder');
                    }

                    columns[i].appendChild(item);
                    columnHeights[i] += randomHeight + 4; // +4 margin-bottom
                    imageIndex++;
                }
            }
            return wrapper;
        }
    </script>
</body>
</html>